<div id="chartHolder">Loading...</div>

<!-- <button type="button" class="fillWidth" onclick="app.fadingPartialChange('#main','about');">learn more</button><br />
 -->
<script>
	app.page = {};

	app.page.charts = {};
	app.page.lastTimestamps = {};
	app.page.timeouts = {};
	app.page.checks = {};
	app.page.chartDataSize = 30;
	app.page.hasChartRendered = {}

	app.page.checksView = function(){
		var params = {};
		app.apiRequest("checksView", "app.page.processChecksView", params);
	};

	app.page.processChecksView = function(api){
		if(api.error != "OK"){ app.showError(api.error); }
		else{
			for(var i in api.checks){
				var name = api.checks[i].name;
				var frequencyInSeconds = api.checks[i].frequencyInSeconds;
				app.page.checks[name] = api.checks[i];
				app.page.lastTimestamps[name] = 0;
				app.page.timeouts[name] = frequencyInSeconds * 1000;
				app.page.hasChartRendered[name] = false;
				app.page.buildChartDom(api.checks[i].name);
				app.page.getData(name);
			}
		}
	}

	app.page.buildChartDom = function(name){
		if($("#chart_" + name).length < 1){
			var html = $("#chartHolder").html();
			if(html == 'Loading...'){html = "";}
			html += '<div class="checkContainer">';
			html += '<h1 id="currentValue_'+name+'">#</h1>';
			html += '<div class="greenH1" id="avgValue_'+name+'">#</div>';
			html += '<div id="chart_'+name+'" style="width: 100%; height: 300px"></div>';
			html += '</div>';
			$("#chartHolder").html(html);
		}
	}

	app.page.buildChart = function(check){
		var name = check.name;
		app.page.charts[name] = new Highcharts.Chart({
			chart: {
				renderTo: "chart_"+name,
				type: 'line',
				backgroundColor: '#00000',
				plotBackgroundColor: '#000000',
			},
				title: {
				text: null
			},
			xAxis: {
				type: 'datetime',
				title: {
					text: null
				}
			},
			yAxis: {
				title: {
					text: null
				}
			},
			series: [
				{
					name: "current",
					lineWidth: 3,
					data: []
				}, 
			]
	  	});
	};

	app.page.getData = function(name){
		var params = {};
		params.check = name;
		params.since = app.page.lastTimestamps[name];
		app.apiRequest("getData", "app.page.processGetData", params);
	}

	app.page.processGetData = function(api){
		if(api.error != "OK"){ app.showError(api.error); }
		else{
			var name = api.checkData.check;
			if(api.check.length == 0){
				app.showError("<strong>"+name+"</strong>: No data for this check");
			}else{
				if(app.page.hasChartRendered[name] == false){
					app.page.buildChart(app.page.checks[name]);
					app.page.hasChartRendered[name] = true;
				}
				var series = app.page.charts[name].series[0];
				for (var i in api.check){
					var slicer = series.data.length > app.page.chartDataSize;
					// var date = new Date(api.check[i].timeStamp);
					// var human_time = date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();
					// console.log(human_time);
					var newPoint = [parseInt(api.check[i].timeStamp), parseInt(api.check[i].number)];
					series.addPoint(newPoint, true, slicer);
					if(api.check[i].timeStamp > app.page.lastTimestamps[name]){
						app.page.lastTimestamps[name] = api.check[i].timeStamp;
					}
				}
				$('#currentValue_'+name).html(name+": "+api.check[i].number);
				var avg = 0;
				var count = 0;
				var total = 0;
				for(var i in series.data){
					total = total + series.data[i].y;
					count++;
				}
				avg = Math.round(total/count,5);
				$("#avgValue_"+name).html("Avg: "+avg);
			}
			setTimeout(app.page.getData, app.page.timeouts[name], name);
		}
	}

	app.page.init = function(){
		app.page.checksView();
	}

</script>